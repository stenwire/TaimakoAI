name: Deploy to VPS

on:
  push:
    branches:
      - prod
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  # PostgreSQL configuration
  POSTGRES_USER: agentic_cx
  POSTGRES_DB: agentic_cx_db
  # Common environment variables for backend container
  BACKEND_ENV: >-
    -e ENVIRONMENT="production"
    -e DATABASE_URL="postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@agentic_cx_postgres:5432/${{ secrets.POSTGRES_DB }}"
    -e GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}"
    -e GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}"
    -e GOOGLE_REDIRECT_URI="${{ secrets.GOOGLE_REDIRECT_URI }}"
    -e FRONTEND_REDIRECT_URI="${{ secrets.FRONTEND_REDIRECT_URI }}"
  # Common environment variables for frontend container
  FRONTEND_ENV: >-
    -e NODE_ENV="production"
    -e NEXT_PUBLIC_ENVIRONMENT="production"
    -e NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL }}"
    -e NEXT_PUBLIC_BACKEND_URL_PROD="${{ secrets.NEXT_PUBLIC_BACKEND_URL_PROD }}"
    -e NEXT_PUBLIC_FRONTEND_URL_PROD="${{ secrets.NEXT_PUBLIC_FRONTEND_URL_PROD }}"

jobs:
  build-and-push-backend:
    runs-on: ld-vps-runner
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.version }}

    steps:
      - name: Set lowercase image names
        id: image-names
        run: |
          echo "backend_image=$(echo '${{ github.repository }}-backend' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
          echo "frontend_image=$(echo '${{ github.repository }}-frontend' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
      
      - name: Free up disk space before build
        run: |
          echo "=== Disk space before cleanup ==="
          df -h
          
          # Aggressive cleanup of Docker resources
          docker system prune -af --volumes || true
          docker buildx prune -af || true
          
          # Remove build caches
          rm -rf /tmp/.buildx-cache-* || true
          rm -rf ~/.docker/buildx-cache || true
          
          # Clean GitHub runner temp files
          rm -rf /home/sten/actions-runner/_work/_temp/* || true
          
          # Remove old logs
          find /home/sten/actions-runner/_diag -name "*.log" -mtime +1 -delete || true
          
          echo "=== Disk space after cleanup ==="
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.image-names.outputs.backend_image }}
          tags: |
            type=sha,prefix=,suffix=,format=short
            type=raw,value=latest

      - name: Build and push Backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.prod
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Use registry cache instead of GitHub Actions cache
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ steps.image-names.outputs.backend_image }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ steps.image-names.outputs.backend_image }}:buildcache,mode=max

      - name: Immediate cleanup after backend build
        if: always()
        run: |
          docker buildx prune -af --keep-storage=500MB
          docker system prune -af --volumes
          rm -rf /tmp/.buildx-cache-* || true
          echo "=== Disk space after backend build ==="
          df -h

  build-and-push-frontend:
    needs: [build-and-push-backend]
    runs-on: ld-vps-runner
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.version }}

    steps:
      - name: Set lowercase image names
        id: image-names
        run: |
          echo "backend_image=$(echo '${{ github.repository }}-backend' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
          echo "frontend_image=$(echo '${{ github.repository }}-frontend' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
      
      - name: Free up disk space before build
        run: |
          echo "=== Disk space before frontend build ==="
          df -h
          
          # Aggressive cleanup
          docker system prune -af --volumes || true
          docker buildx prune -af || true
          rm -rf /tmp/.buildx-cache-* || true
          rm -rf ~/.docker/buildx-cache || true
          rm -rf /home/sten/actions-runner/_work/_temp/* || true
          
          echo "=== Disk space after cleanup ==="
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.image-names.outputs.frontend_image }}
          tags: |
            type=sha,prefix=,suffix=,format=short
            type=raw,value=latest

      - name: Build and push Frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.prod
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Use registry cache instead of GitHub Actions cache
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ steps.image-names.outputs.frontend_image }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ steps.image-names.outputs.frontend_image }}:buildcache,mode=max

      - name: Immediate cleanup after frontend build
        if: always()
        run: |
          docker buildx prune -af --keep-storage=500MB
          docker system prune -af --volumes
          rm -rf /tmp/.buildx-cache-* || true
          echo "=== Disk space after frontend build ==="
          df -h

  deploy:
    needs: [build-and-push-backend, build-and-push-frontend]
    runs-on: ld-vps-runner

    steps:
      - name: Set lowercase image names
        id: image-names
        run: |
          echo "backend_image=$(echo '${{ github.repository }}-backend' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
          echo "frontend_image=$(echo '${{ github.repository }}-frontend' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
      
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Pull latest images
        run: |
          docker pull ${{ env.REGISTRY }}/${{ steps.image-names.outputs.backend_image }}:latest
          docker pull ${{ env.REGISTRY }}/${{ steps.image-names.outputs.frontend_image }}:latest

      - name: Create Docker network
        run: |
          docker network create agentic_cx_network || true

      - name: Deploy PostgreSQL container
        run: |
          # Create data directory for PostgreSQL persistence
          mkdir -p /opt/agentic_cx/postgres_data
          mkdir -p /opt/agentic_cx/backups

          # Check if PostgreSQL container is already running
          if docker ps -a --format '{{.Names}}' | grep -q "agentic_cx_postgres"; then
            echo "PostgreSQL container already exists, checking if running..."
            if ! docker ps --format '{{.Names}}' | grep -q "agentic_cx_postgres"; then
              echo "Starting existing PostgreSQL container..."
              docker start agentic_cx_postgres
            fi
          else
            echo "Creating new PostgreSQL container..."
            docker run -d \
              --name agentic_cx_postgres \
              --network agentic_cx_network \
              --restart unless-stopped \
              -v /opt/agentic_cx/postgres_data:/var/lib/postgresql/data \
              -e POSTGRES_USER="${{ secrets.POSTGRES_USER }}" \
              -e POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
              -e POSTGRES_DB="${{ secrets.POSTGRES_DB }}" \
              postgres:16-alpine
          fi

          # Wait for PostgreSQL to be ready
          echo "Waiting for PostgreSQL to be ready..."
          for i in {1..30}; do
            if docker exec agentic_cx_postgres pg_isready -U "${{ secrets.POSTGRES_USER }}" > /dev/null 2>&1; then
              echo "PostgreSQL is ready!"
              break
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 2
          done

      - name: Deploy Backend container
        run: |
          # Stop and remove existing backend container
          docker stop agentic_cx_backend || true
          docker rm agentic_cx_backend || true

          # Run database migrations in a temporary container
          docker run --rm \
            --network agentic_cx_network \
            ${{ env.BACKEND_ENV }} \
            ${{ env.REGISTRY }}/${{ steps.image-names.outputs.backend_image }}:latest \
            alembic upgrade head

          # Run the backend container
          docker run -d \
            --name agentic_cx_backend \
            --network agentic_cx_network \
            --restart unless-stopped \
            -p 127.0.0.1:8000:8000 \
            ${{ env.BACKEND_ENV }} \
            ${{ env.REGISTRY }}/${{ steps.image-names.outputs.backend_image }}:latest

      - name: Deploy Frontend container
        run: |
          # Stop and remove existing frontend container
          docker stop agentic_cx_frontend || true
          docker rm agentic_cx_frontend || true

          # Run the frontend container
          docker run -d \
            --name agentic_cx_frontend \
            --network agentic_cx_network \
            --restart unless-stopped \
            -p 127.0.0.1:3000:3000 \
            ${{ env.FRONTEND_ENV }} \
            ${{ env.REGISTRY }}/${{ steps.image-names.outputs.frontend_image }}:latest

      - name: Wait for containers to be ready
        run: sleep 10

      - name: Check container health
        run: |
          docker ps -a --filter "name=agentic_cx"

          # Verify containers are running
          if ! docker ps --format '{{.Names}}' | grep -q "agentic_cx_postgres"; then
            echo "PostgreSQL container failed to start!"
            docker logs agentic_cx_postgres
            exit 1
          fi

          if ! docker ps --format '{{.Names}}' | grep -q "agentic_cx_backend"; then
            echo "Backend container failed to start!"
            docker logs agentic_cx_backend
            exit 1
          fi

          if ! docker ps --format '{{.Names}}' | grep -q "agentic_cx_frontend"; then
            echo "Frontend container failed to start!"
            docker logs agentic_cx_frontend
            exit 1
          fi

          echo "All containers are running successfully!"

      - name: Backup database (on successful deploy)
        run: |
          docker exec agentic_cx_postgres pg_dump -U "${{ secrets.POSTGRES_USER }}" "${{ secrets.POSTGRES_DB }}" > /opt/agentic_cx/backups/backup_$(date +%Y%m%d_%H%M%S).sql
          # Keep only last 7 backups
          ls -t /opt/agentic_cx/backups/*.sql | tail -n +8 | xargs -r rm

      - name: Final cleanup
        if: always()
        run: |
          docker system prune -af --filter "until=24h"
          echo "=== Final disk space ==="
          df -h